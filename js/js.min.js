function SelectText(e){var n=document,t=n.getElementById(e);if(n.body.createTextRange)(r=n.body.createTextRange()).moveToElementText(t),r.select();else if(window.getSelection){var o=window.getSelection(),r=n.createRange();r.selectNodeContents(t),o.removeAllRanges(),o.addRange(r)}}function passwordGen(e){e=e||8;var n="",t='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789:;><!"$%&/()=?^*#_-@+[]{}|,.'.split(""),o=t.length,r=0;do{r++,n+=t[Math.floor(Math.random()*o)]}while(r<e);return n}function replaceURLWithHTMLLinks(e){var n=/(\b(https?|ftp|file|mailto|bitcoin|callto|ed2k|git|gtalk|irc|irc6|ircs|jabber|magnet|market|skype|tel):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return e.replace(n,"<a href='$1' target='_new'>$1</a>")}function nl2br(e,n){var t=n||void 0===n?"<br />":"<br>";return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+t+"$2")}function htmlEncode(e){return $("<div/>").text(e).html()}function eachActiveConnection(e){var n={};$(".active").each(function(){var t=$(this).attr("id");if(!n[t])for(var o=peer.connections[t],r=0,i=o.length;r<i;r+=1){var s=o[r];e(s,$(this))}n[t]=1})}function formatFinger(e){for(var n=e.split(""),t="",o=0,r=0;r<n.length;r++)t+=n[r],8==++o&&(t+=" ",o=0);return t}function snobuddyOn(e){eachActiveConnection(function(n,t){if("chat"===n.label)if("-=?OTR?=-"!=e){isMute||$("#chatAudio")[0].play(),nMessages+=1;var o=e.substr(0,5),r=t.find(".messages");e="?MSG:"!=o?replaceURLWithHTMLLinks(nl2br(htmlEncode(e))):'<i class="fa fa-paperclip fa-2x"></i>&nbsp;'+e.substr(5),r.append('<div><span class="peer">'+n.peer+"</span>: "+e+"</div>"),r.scrollTop(r[0].scrollHeight),isFocus||flashTitle("("+nMessages+") "+dTitle,1e8)}else $("#otron").trigger("click")})}function sbuddyOn(e){if(buddy.receiveMsg(e),firstPng&&isStarted&&!isFinger){var n=buddy.priv.fingerprint().toUpperCase(),t=buddy.their_priv_pk.fingerprint().toUpperCase();$("#yfinger").text(formatFinger(n)),$("#bfinger").text(formatFinger(t)),$("#bsend").attr("disabled",!1),$("#bsend").css("background-color","#629007"),$("#bsend").css("border","1px solid #588500"),$("#bsend").css("color","#fff"),$("#bsend").css("cursor","pointer"),$("#auth").show(),$("#waitotr").hide(),isFinger=!0}}function connect(e){$(".filler").html('<img src="loader.gif"><br> connecting...');var n=$("<div></div>").addClass("connection").addClass("active").attr("id",e.peer),t=$("<h1></h1>").html("Chat with <strong>"+e.peer+"</strong>"),o=$("<div><em>Peer connected.</em></div>").addClass("messages");n.append(t),n.append(o),$("#actions").hide(),$("#connections").append(n),$("#"+e.peer).hide(),connectedPeers=1,isStarted||($(".filler").hide(),$("#"+e.peer).show(),$("#send").show(),isStarted=!0),e.on("data",snobuddyOn),e.on("close",function(){clearInterval(intervalId),$("#text").hide(),$("#tarea").html('<font color="red"><strong>'+e.peer+" has left the chat.</strong></font><br>Close this window to remove all data.<br>")})}if(function(){var e,n=document.title;window.flashTitle=function(t,o){function r(){document.title=document.title==n?t:n,--o>0&&(e=setTimeout(r,1e3))}o=parseInt(o),isNaN(o)&&(o=5),cancelFlashTitle(e),r()},window.cancelFlashTitle=function(){clearTimeout(e),document.title=n}}(),window.location.hash){var hash=window.location.hash.substring(1);hash=hash.substr(0,4)}else var hash="";dTitle=$(document).find("title").text(),nMessages=0;var chrome,chrome1,turn,is_chrome=window.chrome;is_chrome&&(chrome=window.navigator.appVersion.match(/Chrom(e|ium)\/(\d+)\./)[2]),chrome1=chrome?parseInt(chrome,10):0,turn={url:"turn:46.165.240.76:3478",credential:"asperTinO1",username:"otrto"};var peer=new Peer("",{host:"sanix-darker.github.io/TORO",port:9e3,path:"/",key:"peerjs",debug:0,secure:!0,logFunction:function(){var e=Array.prototype.slice.call(arguments).join(" ");$(".log").append(e+"<br>")},config:{iceServers:[{url:"stun:46.165.240.76:3478"},{url:"stun:108.61.211.199:3478"},turn]}}),buddy,intervalId,isBuddyOn=!1,connectedPeers=0,isConnected=!1,isBuddy=!1,isMute=!1,isFocus=!0,isFinger=!1,lastPng=0,firstPng=!1,isStarted=!1,dTitle=$(document).find("title").text(),nMessages=0,prevError="",isUpOn=!1,start=(new Date).getTime();peer.on("open",function(e){$("#pid").text(e),$("#purl").text("https://sanix-darker.github.io/TORO/#"+e),$(function(){$("#pid").click(function(){SelectText("pid")})}),$(function(){$("#purl").click(function(){SelectText("purl")})})}),peer.on("connection",connect),peer.on("error",function(e){$("#logg").append('<font color="red"><strong>'+e+". Type:"+e.type+"</strong></font><br>")}),$(function(){var e,n,t,o,r;$("a.linktip").wrap('<span class="tip" />'),$("span.tip").each(function(){r=$(this),e=r.children("a"),n=r.children("span").length,t=0!=e.attr("title"),o='<div id="zone9"><p class="legend">Click here or drag here your file.<br>File will be encrypted before upload.<br>For more information check<br>"Secure File Sharing"</p></div>',e.removeAttr("title"),0===n&&!0===t&&r.append('<span class="answer">'+o+"</span>");var i=r.find("span.answer , span.answer-left").hide();e.click(function(e){var n=e.pageX,t=e.pageY,o=i.width(),r=i.height(),s=($(window).width(),$(window).height(),$(window).scrollTop()),a=$(window).scrollLeft(),c=$(window).scrollTop()+$(window).height();n>a+2*o?i.removeClass("answer").addClass("answer-left"):i.removeClass("answer-left").addClass("answer"),t>s+r&&t>c/2?i.addClass("a-top"):i.removeClass("a-top"),i.fadeIn(100).css("display","block"),e.preventDefault(),isUpOn=!0;var d=$("#zone9").html(),l={input:null,multiple:!1};new FileDrop("zone9",l).event("send",function(e){$("#zone9").html('<br><img src="loader.gif">'),e.each(function(e){e.read({func:"readAsArrayBuffer",onDone:function(n){for(var t=passwordGen(12),o="",r=new Uint8Array(n),s=r.byteLength,a=0;a<s;a++)o+=String.fromCharCode(r[a]);var c=CryptoJS1.AES.encrypt(o,t),l=CryptoJS1.enc.Utf8.parse(c),u=CryptoJS1.enc.Base64.stringify(l);$.post("/f/s.php",{toenc:u,burn:1,isdesc:"",expired:86400,isfile:e.name,issize:e.size}).done(function(n){if(""!=n){var o=CryptoJS1.enc.Utf8.parse(t),r=CryptoJS1.enc.Base64.stringify(o);eachActiveConnection(function(t,o){if("chat"===t.label){var s=o.find(".messages"),a='<a href="https://sanix-darker.github.io/TORO/f/?'+n+"#"+r+'" target="_blank">'+e.name+"</a>";t.send("?MSG:"+a),s.append('<div><span class="you">You: </span> <i class="fa fa-paperclip fa-2x"></i>&nbsp;'+a+"</div>"),s.scrollTop(s[0].scrollHeight),isUpOn=!1,i.fadeOut(200)}})}$("#zone9").html(d)}).error(function(){alert("error"),$("#zone9").html(d)})},onError:function(e){alert("Terrible error!")}})})})}).siblings("span").append('<b class="close">X</b>'),i.on("click",".close",function(){isUpOn=!1,i.fadeOut(200)})})}),$(document).ready(function(){util.supports.data||($("#logg").append("<h3>You have to use Firefox or Chrome for this website</h3>"),$("#logg").append('<font color="red"><strong>Error: Your browser does not support peeer-to-peer connection</strong></font><br>')),$("#connect").on("click",function(){$(".filler").html('<img src="loader.gif"><br> connecting...');var e=$("#rid").val();if(0==connectedPeers&&!isConnected){var n=peer.connect(e,{label:"chat",serialization:"none",reliable:!1,metadata:{message:"hi i want to chat with you!"}});n.on("open",function(){connect(n)}),n.on("error",function(e){var n=e;n!=prevError&&$("#logg").append('<font color="red"><strong>'+e+"</strong></font><br>"),prevError=n,clearInterval(intervalId)}),isConnected=!0,connectedPeers=1,$("#actions").hide()}}),$("#text").keydown(function(e){return 13==e.which&&e.ctrlKey?($("#text").val($("#text").val()+"\n"),!1):13==e.which?($("#send").trigger("submit"),!1):void 0}),$("#rid").keydown(function(e){if(13==e.which)return $("#connect").trigger("click"),!1}),$("#close").click(function(){eachActiveConnection(function(e){e.close()})}),$("#send").on("submit",function(e){e.preventDefault();var n=$("#text").val();isBuddy?buddy.sendMsg(n):eachActiveConnection(function(e){e.send(n)}),eachActiveConnection(function(e,t){if("chat"===e.label){var o=t.find(".messages");o.append('<div><span class="you">You: </span>'+replaceURLWithHTMLLinks(nl2br(htmlEncode(n)))+"</div>"),o.scrollTop(o[0].scrollHeight)}}),$("#text").val(""),$("#text").focus()}),$("#browsers").text(navigator.userAgent),hash&&($("#rid").val(hash),$("#connect").trigger("click"),hash=!1),$(window).on("focus",function(){nMessages=0,cancelFlashTitle(),$(document).prop("title",dTitle),isFocus=!0}),$(window).on("blur",function(){isFocus=!1}),$("#sound").on("click",function(){isMute=!isMute}),$("#otron").on("click",function(){isBuddyOn||($("#bsend").attr("disabled",!0),$("#bsend").css("background-color","#a7a39f"),$("#bsend").css("border","1px solid #000"),$("#bsend").css("color","#000"),$("#bsend").css("cursor","not-allowed"),$("#waitotr").show(),isBuddyOn=!0,eachActiveConnection(function(e){e.send("-=?OTR?=-"),e.off("data",snobuddyOn)}),isBuddy||((buddy=new OTR({fragment_size:140,send_interval:200,priv:new DSA,debug:!1})).REQUIRE_ENCRYPTION=!0,buddy.on("ui",function(e,n){eachActiveConnection(function(n,t){if("chat"===n.label)if("-=pNg=-"!=e){var o=e.substr(0,5);if("?OTR:"!=o){isMute||$("#chatAudio")[0].play(),nMessages+=1;var r=t.find(".messages");e="?MSG:"!=o?replaceURLWithHTMLLinks(nl2br(htmlEncode(e))):'<i class="fa fa-paperclip fa-2x"></i>&nbsp;'+e.substr(5),r.append('<div><span class="peer">'+n.peer+"</span>: "+e+"</div>"),r.scrollTop(r[0].scrollHeight),isFocus||flashTitle("("+nMessages+") "+dTitle,1e8)}}else firstPng=!0,lastPng=(new Date).getTime()})}),buddy.on("io",function(e,n){eachActiveConnection(function(n,t){"chat"===n.label&&n.send(e)})}),buddy.on("error",function(e,n){"error"===n&&console.log("error occurred: "+e)}),buddy.on("status",function(e){OTR.CONST.STATUS_AKE_SUCCESS}),isBuddy=!0,intervalId=setInterval(function(){if(buddy.sendMsg("-=pNg=-"),isStarted)(new Date).getTime()},5e3),eachActiveConnection(function(e){e.on("data",sbuddyOn)}),$("otron").prop("disabled",!0)))}),$("textarea").focus(function(){$(this).css("background","#fff")})}),window.onunload=window.onbeforeunload=function(e){peer&&!peer.destroyed&&peer.destroy()};